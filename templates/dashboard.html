{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}

<h2>Hello, {{ user.username }} üëã</h2>
<p>Welcome back to your Focus Dashboard!</p>

<!-- ================= FOCUS TIMER ================= -->
<section class="focus-timer">
  <h3>Focus Timer</h3>

  <div class="timer-controls">
    <div class="timer-display" id="timerDisplay">25:00</div>

    <input type="range" id="timeSlider" min="0" max="120" step="5" value="25">
    <p>‚è≥ Duration: <span id="timeValue">25</span> minutes</p>

    <div class="timer-buttons">
      <button id="startTimer" class="btn">Start</button>
      <button id="resetTimer" class="btn danger">Reset</button>
    </div>
  </div>
</section>

<!-- ================= FULLSCREEN TIMER MODAL ================= -->
<div id="focusModal" class="focus-modal hidden">
  <div class="focus-content">
    <h2>Focus Mode</h2>
    <div id="focusCountdown" class="focus-countdown">25:00</div>
    <button id="exitFocus" class="btn danger">Exit Focus Mode</button>
  </div>
</div>

<!-- ================= PROGRESS SUMMARY ================= -->
<section class="goal-summary">
  <h3>Your Progress Today</h3>

  <div class="progress-container" style="--progress: {{ percent_today|round(0) }}%;">
    <div class="progress-bar"></div>
  </div>

  <p>{{ completed_today }} of {{ total_today }} goals completed ({{ percent_today|round(0) }}%)</p>
  {% if total_today > 0 and completed_today == total_today %}
    <p class="celebrate">üéâ You‚Äôve completed all your goals for today!</p>
  {% endif %}

</section>

<!-- === Weekly Progress Chart === -->
<section class="weekly-progress card">
  <h3>üìä Weekly Progress</h3>
  <canvas id="progressChart" width="400" height="200"></canvas>
</section>


<!-- ================= ADD GOAL BUTTON + MODAL ================= -->
<section class="add-goal">
  <button id="openGoalModal" class="add-goal-btn">+ Add Goal</button>

  <!-- Modal Overlay -->
  <div id="goalModal" class="modal hidden">
    <div class="modal-content">
      <span id="closeGoalModal" class="close-btn">&times;</span>
      <h3>Add a New Goal</h3>
      <form method="POST" class="goal-form">
        {{ form.hidden_tag() }}
        <div class="form-grid">
          <div>
            <label>{{ form.title.label }}</label>
            {{ form.title(size=40) }}
          </div>
          <div>
            <label>{{ form.category.label }}</label>
            {{ form.category() }}
          </div>
          <div>
            <label>{{ form.repeat_type.label }}</label>
            {{ form.repeat_type(id="repeat_type") }}
          </div>
          <div id="target-day-field">
            <label>{{ form.target_day.label }}</label>
            {{ form.target_day(size=40, id="target_day") }}
          </div>
        </div>
        <label>{{ form.description.label }}</label>
        {{ form.description(rows=3, cols=40) }}
        <p>{{ form.submit(class_="btn btn-primary") }}</p>
      </form>
    </div>
  </div>
</section>


<!-- ================= TOGGLE BUTTON ================= -->
<div class="toggle-container">
  <button id="toggleGoals" class="btn toggle-btn">Show All Goals</button>
</div>

<!-- ================= GOALS + DAILY PRIORITIES ================= -->
<section class="dashboard-grid">

  <!-- === Goals Column === -->
  <div class="goals-column">

    <!-- === Today's Goals === -->
    <div id="todaySection" class="goal-section today-section">
      <h3>Today's Goals</h3>
      {% if goals %}
        <div id="todayGoals" class="goal-grid">
          {% for goal in goals %}
            <div class="goal-card {{ goal.category|lower }} {% if goal.is_completed %}completed{% endif %}"
                 data-goal-id="{{ goal.id }}" draggable="true">
              <div class="goal-header">
                <h4>{{ goal.title }}</h4>
                <span class="badge 
                  {% if goal.repeat_type == 'none' %}badge-once
                  {% elif goal.repeat_type == 'daily' %}badge-daily
                  {% elif goal.repeat_type == 'weekly' %}badge-weekly
                  {% elif goal.repeat_type == 'monthly' %}badge-monthly
                  {% endif %}">
                  {{ goal.repeat_type|capitalize }}
                </span>
              </div>

              <p class="desc">{{ goal.description or '' }}</p>

              <div class="meta">
                <span class="category">{{ goal.category }}</span>
                {% if goal.target_day %}
                  {% if goal.repeat_type == "monthly" %}
                    <span class="target">üóì {{ goal.target_day.split('-')[-1] }}</span>
                  {% else %}
                    <span class="target">üóì {{ goal.target_day }}</span>
                  {% endif %}
                {% endif %}
              </div>

              <div class="actions">
                {% if not goal.is_completed %}
                  <a href="{{ url_for('main.complete_goal', goal_id=goal.id) }}" class="btn-complete">Mark Complete</a>
                {% else %}
                  <span class="completed-text">‚úÖ Completed</span>
                {% endif %}
                <a href="{{ url_for('main.delete_goal', goal_id=goal.id) }}" class="btn danger">Delete</a>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p>No goals scheduled for today üéâ</p>
      {% endif %}
    </div>

    <!-- === All Goals (Hidden Initially) === -->
    <div id="allSection" class="goal-section upcoming-section hidden">
      <h3>All Upcoming Goals</h3>
      {% if all_goals %}
        <div id="allGoals" class="goal-grid">
          {% for goal in all_goals %}
            <div class="goal-card {{ goal.category|lower }} {% if goal.is_completed %}completed{% endif %}"
                 data-goal-id="{{ goal.id }}" draggable="true">
              <div class="goal-header">
                <h4>{{ goal.title }}</h4>
                <span class="badge">{{ goal.repeat_type|capitalize }}</span>
              </div>

              <p class="desc">{{ goal.description or '' }}</p>

              <div class="meta">
                <span class="category">{{ goal.category }}</span>
                {% if goal.target_day %}
                  {% if goal.repeat_type == "monthly" %}
                    <span class="target">üóì {{ goal.target_day.split('-')[-1] }}</span>
                  {% else %}
                    <span class="target">üóì {{ goal.target_day }}</span>
                  {% endif %}
                {% endif %}
              </div>

              <div class="actions">
                {% if not goal.is_completed %}
                  <a href="{{ url_for('main.complete_goal', goal_id=goal.id) }}" class="btn">Mark Complete</a>
                {% else %}
                  <span class="completed-text">‚úÖ Completed</span>
                {% endif %}
                <a href="{{ url_for('main.delete_goal', goal_id=goal.id) }}" class="btn danger">Delete</a>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p>No goals found yet. Add some to get started!</p>
      {% endif %}
    </div>
  </div>

  <!-- === Daily Priority Box === -->
  <div class="planner-column">
    <section class="daily-planner card" id="priorityBox">
      <h3>‚≠ê Priorities</h3>
      <p class="hint">Drag a goal here to make it a priority</p>

      <ul id="priority-list" class="task-list">
        {% for p in priorities %}
          <li class="task-item" data-goal-id="{{ p.id }}" draggable="true">
            <span class="task-title">{{ p.title }}</span>
            <div class="actions">
              <button class="check-btn" data-action="complete" title="Mark Complete">‚úì</button>
              <button class="remove-btn" data-action="remove" title="Remove from Priorities">√ó</button>
            </div>
          </li>
        {% else %}
          <li class="empty">No priorities yet. Drag a goal to add one!</li>
        {% endfor %}
      </ul>
    </section>
  </div>

</section>


<!-- ================= JAVASCRIPT ================= -->
<script src="{{ url_for('static', filename='js/scripts.js') }}"></script>
{% endblock %}
